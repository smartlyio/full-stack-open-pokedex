name: Deployment pipeline

on:
  push: # runs on every push to master
    branches: 
      - master
  pull_request: 
      branches: [master]
      types: [opened, synchronize] # he workflow will run when a PR into the main branch is opened or updated.
jobs: 
    simple_deployment_pipeline:
        runs-on: ubuntu-20.04 # the type of machine to run the job on. What do is run the job on a ubuntu machine.
        steps: 
            - uses : actions/checkout@v3  # this is a github action that checks out the code from the repo. This makes the code available to the job.
            - uses: superfly/flyctl-actions/setup-flyctl@master # Installs the flyctl CLI tool to enable deploying and managing Fly apps
            - uses : actions/setup-node@v3 # this is a github action that sets up node on the machine. This makes node available to the job.
              with: 
                node-version: '16' # this is the version of node to install on the machine.
            - name: Install dependencies # this is a step that installs the dependencies of the project.
              run: npm install
            - name: Check code formatting # this is a step that checks the code formatting.
              run: npm run eslint
            - name: Tests # this is a step that runs the tests.
              run: npm run test
            - name: Build # this is a step that builds the project.
              run: npm run build
            - name: e2e tests # this is a step that runs the end to end tests.
              uses: cypress-io/github-action@v5
              with: 
                command: npm run test:e2e
                start: npm run start-prod
                wait-on: http://localhost:8080
            - name: Deploy
              if: ${{ github.event_name == 'push' }}
              run: flyctl deploy --remote-only
              env: 
                FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
